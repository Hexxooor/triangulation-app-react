@echo off
:: =============================================================================
:: Triangulation App - Vollst√§ndige Installation f√ºr Windows
:: Installiert Python, Node.js und alle Dependencies automatisch
:: =============================================================================

setlocal EnableDelayedExpansion
color 0A

echo.
echo  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó
echo  ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë
echo     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë
echo     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë
echo     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë
echo     ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù
echo.
echo                                    üéØ VOLLST√ÑNDIGE INSTALLATION üéØ
echo.
echo ================================================================================
echo.

:: Pr√ºfen ob Admin-Rechte vorhanden sind
net session >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ùå FEHLER: Bitte als Administrator ausf√ºhren!
    echo.
    echo Rechtsklick auf die Datei ‚Üí "Als Administrator ausf√ºhren"
    echo.
    pause
    exit /b 1
)

echo ‚úÖ Administrator-Rechte erkannt
echo.

:: Arbeitsverzeichnis setzen
set "APP_DIR=%~dp0"
cd /d "%APP_DIR%"

echo üìÅ Arbeitsverzeichnis: %APP_DIR%
echo.

:: =============================================================================
:: SCHRITT 1: Python Installation pr√ºfen/installieren
:: =============================================================================
echo ================================================================================
echo üêç SCHRITT 1: Python Installation
echo ================================================================================
echo.

python --version >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ö†Ô∏è  Python nicht gefunden - wird automatisch installiert...
    echo.
    
    :: Python Installer herunterladen
    echo üì• Python 3.11 wird heruntergeladen...
    if not exist "python-installer.exe" (
        powershell -Command "& {[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri 'https://www.python.org/ftp/python/3.11.6/python-3.11.6-amd64.exe' -OutFile 'python-installer.exe'}"
    )
    
    echo üîß Python wird installiert...
    python-installer.exe /quiet InstallAllUsers=1 PrependPath=1 Include_test=0
    
    :: Warten bis Installation abgeschlossen
    timeout /t 30 /nobreak >nul
    
    :: PATH aktualisieren
    refreshenv
    
    :: Erneut pr√ºfen
    python --version >nul 2>&1
    if %errorlevel% neq 0 (
        echo ‚ùå Python Installation fehlgeschlagen!
        echo Bitte Python manuell von https://python.org installieren
        pause
        exit /b 1
    )
    
    :: Installer l√∂schen
    del python-installer.exe >nul 2>&1
    
    echo ‚úÖ Python erfolgreich installiert!
) else (
    for /f "tokens=*" %%i in ('python --version 2^>^&1') do set PYTHON_VERSION=%%i
    echo ‚úÖ Python bereits installiert: !PYTHON_VERSION!
)

:: pip aktualisieren
echo üì¶ pip wird aktualisiert...
python -m pip install --upgrade pip --quiet
echo.

:: =============================================================================
:: SCHRITT 2: Node.js Installation pr√ºfen/installieren
:: =============================================================================
echo ================================================================================
echo üü¢ SCHRITT 2: Node.js Installation
echo ================================================================================
echo.

node --version >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ö†Ô∏è  Node.js nicht gefunden - wird automatisch installiert...
    echo.
    
    :: Node.js Installer herunterladen
    echo üì• Node.js LTS wird heruntergeladen...
    if not exist "nodejs-installer.msi" (
        powershell -Command "& {[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri 'https://nodejs.org/dist/v18.18.2/node-v18.18.2-x64.msi' -OutFile 'nodejs-installer.msi'}"
    )
    
    echo üîß Node.js wird installiert...
    msiexec /i nodejs-installer.msi /quiet /norestart
    
    :: Warten bis Installation abgeschlossen
    timeout /t 60 /nobreak >nul
    
    :: PATH aktualisieren
    set "PATH=%PATH%;%ProgramFiles%\nodejs"
    
    :: Erneut pr√ºfen
    node --version >nul 2>&1
    if %errorlevel% neq 0 (
        echo ‚ùå Node.js Installation fehlgeschlagen!
        echo Bitte Node.js manuell von https://nodejs.org installieren
        pause
        exit /b 1
    )
    
    :: Installer l√∂schen
    del nodejs-installer.msi >nul 2>&1
    
    echo ‚úÖ Node.js erfolgreich installiert!
) else (
    for /f "tokens=*" %%i in ('node --version 2^>^&1') do set NODE_VERSION=%%i
    echo ‚úÖ Node.js bereits installiert: !NODE_VERSION!
)

:: npm Version pr√ºfen
npm --version >nul 2>&1
if %errorlevel% neq 0 (
    echo ‚ùå npm nicht gefunden!
    pause
    exit /b 1
) else (
    for /f "tokens=*" %%i in ('npm --version 2^>^&1') do set NPM_VERSION=%%i
    echo ‚úÖ npm verf√ºgbar: v!NPM_VERSION!
)
echo.

:: =============================================================================
:: SCHRITT 3: Backend Setup
:: =============================================================================
echo ================================================================================
echo üîß SCHRITT 3: Backend (Python Flask) Setup
echo ================================================================================
echo.

if not exist "backend" (
    echo ‚ùå Backend-Verzeichnis nicht gefunden!
    pause
    exit /b 1
)

cd backend

echo üì¶ Virtual Environment wird erstellt...
if exist "venv" (
    echo ‚ö†Ô∏è  Vorhandenes venv wird gel√∂scht...
    rmdir /s /q venv
)

python -m venv venv
if %errorlevel% neq 0 (
    echo ‚ùå Virtual Environment konnte nicht erstellt werden!
    pause
    exit /b 1
)

echo üîß Virtual Environment wird aktiviert...
call venv\Scripts\activate.bat

echo üì• Python Dependencies werden installiert...
pip install --upgrade pip
pip install -r requirements.txt
if %errorlevel% neq 0 (
    echo ‚ùå Backend Dependencies konnten nicht installiert werden!
    pause
    exit /b 1
)

echo ‚úÖ Backend Setup erfolgreich!
echo.

:: Zur√ºck zum Hauptverzeichnis
cd ..

:: =============================================================================
:: SCHRITT 4: Frontend Setup
:: =============================================================================
echo ================================================================================
echo ‚öõÔ∏è  SCHRITT 4: Frontend (React) Setup
echo ================================================================================
echo.

if not exist "frontend" (
    echo ‚ùå Frontend-Verzeichnis nicht gefunden!
    pause
    exit /b 1
)

cd frontend

echo üì• NPM Dependencies werden installiert...
echo (Das kann einige Minuten dauern...)
call npm install
if %errorlevel% neq 0 (
    echo ‚ùå Frontend Dependencies konnten nicht installiert werden!
    echo Versuche alternative Installation...
    call npm install --legacy-peer-deps
    if %errorlevel% neq 0 (
        echo ‚ùå Frontend Installation fehlgeschlagen!
        pause
        exit /b 1
    )
)

echo ‚úÖ Frontend Setup erfolgreich!
echo.

:: Zur√ºck zum Hauptverzeichnis
cd ..

:: =============================================================================
:: SCHRITT 5: Desktop-Verkn√ºpfungen erstellen
:: =============================================================================
echo ================================================================================
echo üñ•Ô∏è  SCHRITT 5: Desktop-Verkn√ºpfungen erstellen
echo ================================================================================
echo.

:: Verkn√ºpfung f√ºr App-Start erstellen
set "SHORTCUT_PATH=%USERPROFILE%\Desktop\Triangulation App.lnk"
powershell -Command "$WshShell = New-Object -comObject WScript.Shell; $Shortcut = $WshShell.CreateShortcut('%SHORTCUT_PATH%'); $Shortcut.TargetPath = '%APP_DIR%start.bat'; $Shortcut.WorkingDirectory = '%APP_DIR%'; $Shortcut.IconLocation = 'shell32.dll,23'; $Shortcut.Description = 'Triangulation App starten'; $Shortcut.Save()"

echo ‚úÖ Desktop-Verkn√ºpfung erstellt: "Triangulation App"
echo.

:: =============================================================================
:: SCHRITT 6: Firewall-Regeln (Optional)
:: =============================================================================
echo ================================================================================
echo üî• SCHRITT 6: Firewall-Konfiguration (Optional)
echo ================================================================================
echo.

echo Sollen Firewall-Regeln f√ºr die App erstellt werden? (j/n)
set /p FIREWALL_CHOICE="> "

if /i "!FIREWALL_CHOICE!"=="j" (
    echo üîß Firewall-Regeln werden erstellt...
    netsh advfirewall firewall add rule name="Triangulation App - Frontend" dir=in action=allow protocol=TCP localport=3000
    netsh advfirewall firewall add rule name="Triangulation App - Backend" dir=in action=allow protocol=TCP localport=5000
    echo ‚úÖ Firewall-Regeln erstellt
) else (
    echo ‚è≠Ô∏è  Firewall-Konfiguration √ºbersprungen
)
echo.

:: =============================================================================
:: INSTALLATION ABGESCHLOSSEN
:: =============================================================================
echo ================================================================================
echo üéâ INSTALLATION ERFOLGREICH ABGESCHLOSSEN!
echo ================================================================================
echo.
echo ‚úÖ Python installiert und konfiguriert
echo ‚úÖ Node.js installiert und konfiguriert  
echo ‚úÖ Backend Dependencies installiert
echo ‚úÖ Frontend Dependencies installiert
echo ‚úÖ Desktop-Verkn√ºpfung erstellt
echo.
echo üöÄ Die App kann jetzt gestartet werden:
echo.
echo    üì± Option 1: Doppelklick auf Desktop-Verkn√ºpfung "Triangulation App"
echo    üì± Option 2: start.bat in diesem Ordner ausf√ºhren
echo    üì± Option 3: Manuell mit den folgenden Befehlen:
echo.
echo        Backend:  cd backend ^&^& venv\Scripts\activate ^&^& python app.py
echo        Frontend: cd frontend ^&^& npm start
echo.
echo üåê Nach dem Start √∂ffnet sich die App automatisch im Browser:
echo    Frontend: http://localhost:3000
echo    Backend:  http://localhost:5000
echo.
echo üìö Weitere Informationen in der README.md
echo.
echo ================================================================================

:: Fragen ob die App direkt gestartet werden soll
echo.
echo Soll die App jetzt gestartet werden? (j/n)
set /p START_CHOICE="> "

if /i "!START_CHOICE!"=="j" (
    echo.
    echo üöÄ App wird gestartet...
    start "" "%APP_DIR%start.bat"
    echo.
    echo ‚úÖ Die App startet in einem neuen Fenster!
    echo    Frontend: http://localhost:3000
    echo    Backend:  http://localhost:5000
) else (
    echo.
    echo ‚úÖ Installation abgeschlossen!
    echo    Verwenden Sie die Desktop-Verkn√ºpfung zum Starten.
)

echo.
echo Dr√ºcken Sie eine beliebige Taste zum Beenden...
pause >nul
