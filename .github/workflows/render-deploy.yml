# üöÄ Render.com Deployment Workflow
# Automatisches Deployment zur Render.com nach erfolgreichem CI

<<<<<<< HEAD
name: üåé Deploy to Render.com
=======
name: üåê Deploy to Render.com
>>>>>>> 4a542fb (f)

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["üéØ Triangulation App CI/CD"]
    types:
      - completed

env:
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

jobs:
  # =============================================================================
  # RENDER DEPLOYMENT
  # =============================================================================
  deploy-to-render:
    name: üöÄ Deploy to Render.com
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      # =============================================================================
      # RENDER SERVICE DEPLOYMENT VIA API
      # =============================================================================
      - name: üöÄ Deploy Frontend to Render
        run: |
          curl -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "web_service",
              "name": "triangulation-frontend",
              "repo": "https://github.com/${{ github.repository }}",
              "branch": "main",
              "dockerfilePath": "./frontend/Dockerfile.render",
              "dockerContext": "./frontend",
              "plan": "free",
              "region": "frankfurt",
              "env": [
                {
                  "key": "NODE_ENV",
                  "value": "production"
                },
                {
                  "key": "REACT_APP_API_URL",
                  "value": "https://triangulation-backend.onrender.com"
                }
              ],
              "healthCheckPath": "/health"
            }'
      
      - name: üöÄ Deploy Backend to Render
        run: |
          curl -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "web_service",
              "name": "triangulation-backend",
              "repo": "https://github.com/${{ github.repository }}",
              "branch": "main",
              "dockerfilePath": "./backend/Dockerfile.render",
              "dockerContext": "./backend",
              "plan": "free",
              "region": "frankfurt",
              "env": [
                {
                  "key": "FLASK_ENV",
                  "value": "production"
                },
                {
                  "key": "PYTHONUNBUFFERED",
                  "value": "1"
                }
              ],
              "healthCheckPath": "/api/health"
            }'
      
      # =============================================================================
      # DEPLOYMENT VERIFICATION
      # =============================================================================
      - name: üîç Verify Deployment
        run: |
          echo "‚è≥ Warte auf Deployment-Completion..."
          sleep 60
          
          # Frontend Health Check
          FRONTEND_URL="https://triangulation-frontend.onrender.com"
          echo "üîç Teste Frontend: $FRONTEND_URL"
          
          for i in {1..10}; do
            if curl -f "$FRONTEND_URL/health" --max-time 30; then
              echo "‚úÖ Frontend ist online!"
              break
            else
              echo "‚è≥ Versuch $i/10 - Frontend noch nicht bereit"
              sleep 30
            fi
          done
          
          # Backend Health Check
          BACKEND_URL="https://triangulation-backend.onrender.com"
          echo "üîç Teste Backend: $BACKEND_URL"
          
          for i in {1..10}; do
            if curl -f "$BACKEND_URL/api/health" --max-time 30; then
              echo "‚úÖ Backend ist online!"
              break
            else
              echo "‚è≥ Versuch $i/10 - Backend noch nicht bereit"
              sleep 30
            fi
          done
      
      # =============================================================================
      # SUCCESS NOTIFICATION
      # =============================================================================
      - name: üéâ Deployment Success
        run: |
          echo "üéâ Deployment zu Render.com erfolgreich!"
          echo ""
<<<<<<< HEAD
          echo "üåé URLs:"
=======
          echo "üåê URLs:"
>>>>>>> 4a542fb (f)
          echo "Frontend: https://triangulation-frontend.onrender.com"
          echo "Backend:  https://triangulation-backend.onrender.com"
          echo ""
          echo "üìä Features verf√ºgbar:"
          echo "- üéØ Triangulation mit Drag & Drop"
          echo "- üìç GPS-Integration"
          echo "- üì± Mobile-optimiert"
          echo "- üîß Genauigkeitseinstellungen"

  # =============================================================================
  # ALTERNATIVE: WEBHOOK-BASED DEPLOYMENT
  # =============================================================================
  trigger-render-webhooks:
    name: üîó Trigger Render Webhooks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: üöÄ Trigger Frontend Deployment
        if: secrets.RENDER_FRONTEND_WEBHOOK
        run: |
          curl -X POST "${{ secrets.RENDER_FRONTEND_WEBHOOK }}"
          echo "‚úÖ Frontend Deployment triggered"
      
      - name: üöÄ Trigger Backend Deployment  
        if: secrets.RENDER_BACKEND_WEBHOOK
        run: |
          curl -X POST "${{ secrets.RENDER_BACKEND_WEBHOOK }}"
          echo "‚úÖ Backend Deployment triggered"

  # =============================================================================
  # DEPLOYMENT STATUS CHECK
  # =============================================================================
  check-render-status:
    name: üìä Check Render Status
    runs-on: ubuntu-latest
    needs: [deploy-to-render]
    if: always()
    
    steps:
      - name: üìä Get Service Status
        if: env.RENDER_API_KEY
        run: |
          echo "üìä Render Service Status:"
          
          # Liste alle Services
          curl -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services" | jq '.[] | select(.service.name | contains("triangulation")) | {name: .service.name, status: .service.status, url: .service.serviceDetails.url}'
      
      - name: üîó Service URLs
        run: |
<<<<<<< HEAD
          echo "üåé Deine App ist live unter:"
=======
          echo "üåê Deine App ist live unter:"
>>>>>>> 4a542fb (f)
          echo "Frontend: https://triangulation-frontend.onrender.com"
          echo "Backend:  https://triangulation-backend.onrender.com"
          echo ""
          echo "üéØ Features:"
          echo "- Drag & Drop Triangulation"
          echo "- GPS Integration"
          echo "- Mobile Responsive"
<<<<<<< HEAD
          echo "- Real-time Calculations"
=======
          echo "- Real-time Calculations"
>>>>>>> 4a542fb (f)
