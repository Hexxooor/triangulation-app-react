# ğŸš€ Render.com Deployment Workflow
# Automatisches Deployment zur Render.com nach erfolgreichem CI

name: ğŸŒ Deploy to Render.com

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["ğŸ¯ Triangulation App CI/CD"]
    types:
      - completed

env:
  RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}

jobs:
  # =============================================================================
  # RENDER DEPLOYMENT
  # =============================================================================
  deploy-to-render:
    name: ğŸš€ Deploy to Render.com
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      # =============================================================================
      # RENDER SERVICE DEPLOYMENT VIA API
      # =============================================================================
      - name: ğŸš€ Deploy Frontend to Render
        run: |
          curl -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "web_service",
              "name": "triangulation-frontend",
              "repo": "https://github.com/${{ github.repository }}",
              "branch": "main",
              "dockerfilePath": "./frontend/Dockerfile.render",
              "dockerContext": "./frontend",
              "plan": "free",
              "region": "frankfurt",
              "env": [
                {
                  "key": "NODE_ENV",
                  "value": "production"
                },
                {
                  "key": "REACT_APP_API_URL",
                  "value": "https://triangulation-backend.onrender.com"
                }
              ],
              "healthCheckPath": "/health"
            }'
      
      - name: ğŸš€ Deploy Backend to Render
        run: |
          curl -X POST "https://api.render.com/v1/services" \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "web_service",
              "name": "triangulation-backend",
              "repo": "https://github.com/${{ github.repository }}",
              "branch": "main",
              "dockerfilePath": "./backend/Dockerfile.render",
              "dockerContext": "./backend",
              "plan": "free",
              "region": "frankfurt",
              "env": [
                {
                  "key": "FLASK_ENV",
                  "value": "production"
                },
                {
                  "key": "PYTHONUNBUFFERED",
                  "value": "1"
                }
              ],
              "healthCheckPath": "/api/health"
            }'
      
      # =============================================================================
      # DEPLOYMENT VERIFICATION
      # =============================================================================
      - name: ğŸ” Verify Deployment
        run: |
          echo "â³ Warte auf Deployment-Completion..."
          sleep 60
          
          # Frontend Health Check
          FRONTEND_URL="https://triangulation-frontend.onrender.com"
          echo "ğŸ” Teste Frontend: $FRONTEND_URL"
          
          for i in {1..10}; do
            if curl -f "$FRONTEND_URL/health" --max-time 30; then
              echo "âœ… Frontend ist online!"
              break
            else
              echo "â³ Versuch $i/10 - Frontend noch nicht bereit"
              sleep 30
            fi
          done
          
          # Backend Health Check
          BACKEND_URL="https://triangulation-backend.onrender.com"
          echo "ğŸ” Teste Backend: $BACKEND_URL"
          
          for i in {1..10}; do
            if curl -f "$BACKEND_URL/api/health" --max-time 30; then
              echo "âœ… Backend ist online!"
              break
            else
              echo "â³ Versuch $i/10 - Backend noch nicht bereit"
              sleep 30
            fi
          done
      
      # =============================================================================
      # SUCCESS NOTIFICATION
      # =============================================================================
      - name: ğŸ‰ Deployment Success
        run: |
          echo "ğŸ‰ Deployment zu Render.com erfolgreich!"
          echo ""
          echo "ğŸŒ URLs:"
          echo "Frontend: https://triangulation-frontend.onrender.com"
          echo "Backend:  https://triangulation-backend.onrender.com"
          echo ""
          echo "ğŸ“Š Features verfÃ¼gbar:"
          echo "- ğŸ¯ Triangulation mit Drag & Drop"
          echo "- ğŸ“ GPS-Integration"
          echo "- ğŸ“± Mobile-optimiert"
          echo "- ğŸ”§ Genauigkeitseinstellungen"

  # =============================================================================
  # ALTERNATIVE: WEBHOOK-BASED DEPLOYMENT
  # =============================================================================
  trigger-render-webhooks:
    name: ğŸ”— Trigger Render Webhooks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸš€ Trigger Frontend Deployment
        if: secrets.RENDER_FRONTEND_WEBHOOK
        run: |
          curl -X POST "${{ secrets.RENDER_FRONTEND_WEBHOOK }}"
          echo "âœ… Frontend Deployment triggered"
      
      - name: ğŸš€ Trigger Backend Deployment  
        if: secrets.RENDER_BACKEND_WEBHOOK
        run: |
          curl -X POST "${{ secrets.RENDER_BACKEND_WEBHOOK }}"
          echo "âœ… Backend Deployment triggered"

  # =============================================================================
  # DEPLOYMENT STATUS CHECK
  # =============================================================================
  check-render-status:
    name: ğŸ“Š Check Render Status
    runs-on: ubuntu-latest
    needs: [deploy-to-render]
    if: always()
    
    steps:
      - name: ğŸ“Š Get Service Status
        if: env.RENDER_API_KEY
        run: |
          echo "ğŸ“Š Render Service Status:"
          
          # Liste alle Services
          curl -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services" | jq '.[] | select(.service.name | contains("triangulation")) | {name: .service.name, status: .service.status, url: .service.serviceDetails.url}'
      
      - name: ğŸ”— Service URLs
        run: |
          echo "ğŸŒ Deine App ist live unter:"
          echo "Frontend: https://triangulation-frontend.onrender.com"
          echo "Backend:  https://triangulation-backend.onrender.com"
          echo ""
          echo "ğŸ¯ Features:"
          echo "- Drag & Drop Triangulation"
          echo "- GPS Integration"
          echo "- Mobile Responsive"
          echo "- Real-time Calculations"
